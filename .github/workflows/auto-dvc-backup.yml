name: Auto DVC Backup (Postgres + Pinecone)

on:
  push:
    branches: [ main ]

  schedule:
    # Daily at 2 AM UTC
    - cron: "0 2 * * *"

  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:

    # 1. Checkout
    - name: Checkout Repo
      uses: actions/checkout@v4

    # 2. Python
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.9"

    # 3. Install Dependencies
    - name: Install Dependencies
      run: |
        pip install dvc dvc-gs pinecone python-dotenv psycopg2-binary

    # 4. Setup GCP Auth
    - name: Setup GCP Auth
      run: |
        echo '${{ secrets.GCP_SA_KEY }}' > gcp-key.json
        echo "GOOGLE_APPLICATION_CREDENTIALS=$PWD/gcp-key.json" >> $GITHUB_ENV

    # 5. Set Postgres Password
    - name: Set Postgres Password
      run: |
        echo "PGPASSWORD=${{ secrets.PG_PASSWORD }}" >> $GITHUB_ENV

    # 6. Setup Pinecone Env
    - name: Setup Pinecone Env
      run: |
        echo "PINECONE_API_KEY=${{ secrets.PINECONE_API_KEY }}" >> $GITHUB_ENV
        echo "PINECONE_INDEX_NAME=${{ secrets.PINECONE_INDEX_NAME }}" >> $GITHUB_ENV

    # 7. Run Postgres Backup
    - name: Backup PostgreSQL
      run: |
        chmod +x backup_courseweave.sh
        ./backup_courseweave.sh

    # 8. Export Pinecone
    - name: Export Pinecone Vectors
      run: |
        python export_pinecone.py

    # 9. Track with DVC
    - name: Track with DVC
      run: |
        dvc add db/postgres_dumps
        dvc add data/embeddings/pinecone_exports

    # 10. Push to GCS
    - name: Push to DVC Remote
      run: |
        dvc push

    # 11. Commit to GitHub
    - name: Commit Changes
      run: |
        git config user.name "github-actions"
        git config user.email "actions@github.com"

        git add db/postgres_dumps.dvc \
                data/embeddings/pinecone_exports.dvc \
                .gitignore

        git commit -m "Auto backup: DB + Pinecone" || echo "No changes"

        git push