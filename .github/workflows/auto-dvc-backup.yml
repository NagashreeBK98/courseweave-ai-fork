name: CourseWeave Auto DVC Backup

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  dvc-backup:
    runs-on: ubuntu-latest

    steps:
      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Setup Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      # Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install dvc dvc-gs pinecone-client pinecone
          pip install -r requirements.txt

      # Authenticate with Google Cloud
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          export_environment_variables: true

      # Export ADC for DVC
      - name: Set Google ADC for DVC
        run: |
          echo "GOOGLE_APPLICATION_CREDENTIALS=$GOOGLE_GHA_CREDS_PATH" >> $GITHUB_ENV

      # Ensure postgres dump directory exists
      - name: Ensure dump directory exists
        run: mkdir -p db/postgres_dumps

      # Run PostgreSQL backup
      - name: Backup PostgreSQL
        env:
          PGHOST: ${{ secrets.PGHOST }}
          PGPORT: ${{ secrets.PGPORT }}
          PGDATABASE: ${{ secrets.PGDATABASE }}
          PGUSER: ${{ secrets.PGUSER }}
          PGPASSWORD: ${{ secrets.PG_PASSWORD }}
        run: |
          chmod +x backup_courseweave.sh
          ./backup_courseweave.sh

      # Export Pinecone vectors
      - name: Export Pinecone vectors
        env:
          PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
          PINECONE_INDEX_NAME: ${{ secrets.PINECONE_INDEX_NAME }}
        run: |
          mkdir -p data/embeddings/pinecone_exports
          python export_pinecone.py

      # Track new data with DVC
      - name: Track data with DVC
        run: |
          dvc add db/postgres_dumps
          dvc add data/embeddings/pinecone_exports

      # Push to DVC remote (GCS)
      - name: Push to DVC Remote
        run: dvc push

      # Commit DVC metadata
      - name: Commit DVC metadata
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add .
          git commit -m "Automated DB + Pinecone backup" || echo "No changes"
          git pull --rebase origin main || echo "No remote changes"
          git push origin main
